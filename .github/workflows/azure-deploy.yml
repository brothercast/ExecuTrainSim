name: Build and deploy Node.js app to Azure Web App - ExecuTrainSim  
  
on:  
  push:  
    branches:  
      - main  
  workflow_dispatch:  
  
jobs:  
  build:  
    runs-on: ubuntu-latest  
  
    steps:  
    - uses: actions/checkout@v4  
  
    - name: Set up Node.js version  
      uses: actions/setup-node@v3  
      with:  
        node-version: '18.x'  
  
    - name: Install dependencies for front-end  
      working-directory: ./executrainsim  
      run: |  
        npm install  
  
    - name: Build front-end  
      working-directory: ./executrainsim  
      run: |  
        npm run build  
  
    - name: Install dependencies for back-end  
      working-directory: ./execuTrainServer  
      run: npm install  
  
    - name: Upload build artifact  
      uses: actions/upload-artifact@v4  
      with:  
        name: node-app  
        path: |  
          executrainsim/build  
          execuTrainServer  
  
  deploy:  
    runs-on: ubuntu-latest  
    needs: build  
    environment:  
      name: 'Production'  
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}  
    permissions:  
      id-token: write  
  
    steps:  
    - name: Download artifact from build job  
      uses: actions/download-artifact@v4  
      with:  
        name: node-app  
  
    - name: Login to Azure  
      uses: azure/login@v2  
      with:  
        creds: ${{ secrets.AZURE_CREDENTIALS }}  
  
    - name: Deploy to Azure Web App  
      id: deploy-to-webapp  
      uses: azure/webapps-deploy@v3  
      with:  
        app-name: 'ExecuTrainSim'  
        slot-name: 'production'  
        package: '.'  
  
    - name: Verify deployment  
      run: |  
        curl -I ${{ steps.deploy-to-webapp.outputs.webapp-url }}  