# azure-deploy.yml - Optimized Workflow for Full App Deployment to Azure
name: ğŸš€ Deploy Full Node.js App to Azure Web App

on:
  push:
    branches:
      - main # or your production branch

  workflow_dispatch: # Enable manual triggering from GitHub Actions UI

env:
  AZURE_WEBAPP_NAME: 'ExecuTrainSim' # âš™ï¸ Replace with your Azure Web App name
  AZURE_RESOURCE_GROUP: 'ExecuTrainSimGroup' # âš™ï¸ Replace with your Azure Resource Group name
  NODE_VERSION: '20.x' # âš™ï¸ Set your desired Node.js version here

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production # Marks this as a production deployment

    steps:
      - name: â˜ï¸ Checkout code # â¬‡ï¸ Get code from GitHub repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Node.js environment # âš™ï¸ Define Node.js environment for build and deploy
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }} # Use version defined in workflow environment variables

      - name: ğŸ—ï¸ Install and Build Application # ğŸ“¦ Install dependencies and build both client and server
        run: |
          echo "âš™ï¸ Starting full application install and build process..."
          echo "  â¡ï¸ Building executrainsim (React Client)..."
          cd executrainsim
          npm ci # âš¡ï¸ Use npm ci for clean and faster installs in CI
          npm run build # ğŸ”¨ Build React application
          echo "  âœ… executrainsim build completed successfully."
          cd ..
          echo "  â¡ï¸ Installing executrainserver (Node.js Server) dependencies..."
          cd executrainserver
          npm ci # âš¡ï¸ Use npm ci for clean and faster server dependency install
          echo "  âœ… executrainserver dependencies installed successfully."
          echo "âœ… Full application install and build process completed."
          cd .. # Return to workspace root

      - name: ğŸ“¦ Prepare Deployment Package # ğŸ“‚ Create deployment package with necessary files in correct structure
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          rm -rf deployment-package # ğŸ§¹ Clean up any previous package
          mkdir deployment-package # ğŸ“‚ Create a fresh deployment package directory

          echo "  ğŸ“‚ Creating deployment-package/executrainserver directory"
          mkdir deployment-package/executrainserver # ğŸ“‚ Create server subdirectory
          echo "  â¡ï¸ Copying executrainserver files..."
          cp -r executrainserver/* deployment-package/executrainserver/ # ğŸ“‚ Copy server files into subdirectory

          echo "  ğŸ“‚ Creating deployment-package/executrainsim-build directory"
          mkdir deployment-package/executrainsim-build # ğŸ“‚ Create client build subdirectory
          echo "  â¡ï¸ Copying executrainsim build output..."
          cp -r executrainsim/build/* deployment-package/executrainsim-build/ # ğŸ“‚ Copy client build to subdirectory

          echo "  â¡ï¸ Copying startup.sh to deployment package root..."
          cp startup.sh deployment-package/ # ğŸ“‚ Copy startup script to package root

          echo "âœ… Deployment package created successfully at deployment-package."
          echo "  ğŸ” Listing contents of deployment-package root:"
          ls -l deployment-package
          echo "  ğŸ” Listing contents of deployment-package/executrainserver:"
          ls -l deployment-package/executrainserver
          echo "  ğŸ” Listing contents of deployment-package/executrainsim-build:"
          ls -l deployment-package/executrainsim-build

      - name: ğŸ”’ Login to Azure # ğŸ”‘ Authenticate with Azure using Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # ğŸ”‘ Use AZURE_CREDENTIALS secret

      - name: ğŸš€ Deploy to Azure Web App # â˜ï¸ Deploy deployment package to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }} # âš™ï¸ Use Web App name from environment variable
          slot-name: 'production' # ğŸ¯ Deploy to production slot
          package: deployment-package # ğŸ“¦ Deploy the 'deployment-package' directory

      - name: âš™ï¸ Set WEBSITE_NODE_DEFAULT_VERSION App Setting via Azure CLI # ğŸ› ï¸ Ensure correct Node.js version on Azure
        run: |
          echo "âš™ï¸ Setting WEBSITE_NODE_DEFAULT_VERSION App Setting via Azure CLI..."
          az webapp config appsettings set --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --settings WEBSITE_NODE_DEFAULT_VERSION="${{ env.NODE_VERSION }}"
          echo "âœ… WEBSITE_NODE_DEFAULT_VERSION App Setting set to ${{ env.NODE_VERSION }} via Azure CLI."