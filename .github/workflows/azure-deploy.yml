# azure-deploy.yml (Force Clean Package and Casing)
name: Deploy Node.js App to Azure

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Install and Build
      run: |
        echo "Starting Install and Build process..."
        echo "Navigating to executrainsim directory and running npm ci"
        cd executrainsim
        npm ci
        echo "NPM install complete for executrainsim"
        echo "Running npm run build for executrainsim"
        npm run build
        echo "NPM run build complete for executrainsim"
        echo "Navigating to executrainserver directory and running npm ci"
        cd ../executrainserver
        npm ci
        echo "NPM install complete for executrainserver"
        echo "Install and build process complete."

    - name: Prepare Deployment Package
      run: |
        echo "Creating deployment package..."
        rm -rf deployment-package  # Ensure clean package directory - DELETE if exists
        mkdir deployment-package
        cp -r executrainserver/* deployment-package/  # Copy server - ensure lowercase source
        mkdir deployment-package/executrainsim-build
        cp -r executrainsim/build/* deployment-package/executrainsim-build/
        cp startup.sh deployment-package/
        echo "Deployment package created."
        echo "Listing contents of deployment-package BEFORE deployment:" # Debugging
        ls -l deployment-package # Debugging: List package contents

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'ExecuTrainSim'
        slot-name: 'production'
        package: deployment-package # Deploy the created package directory