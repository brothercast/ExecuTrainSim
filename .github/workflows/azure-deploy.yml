# azure-deploy.yml - Refactored for Simplicity and Robustness
name: Deploy Node.js App to Azure

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Install and Build
      run: |
        echo "Starting Install and Build process..."
        echo "Navigating to executrainsim directory and running npm ci"
        cd executrainsim
        npm ci
        echo "NPM install complete for executrainsim"
        echo "Running npm run build for executrainsim"
        npm run build
        echo "NPM run build complete for executrainsim"
        echo "Navigating to executrainserver directory and running npm ci"
        cd ../executrainserver
        npm ci
        echo "NPM install complete for executrainserver"
        echo "Install and build process complete."

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'ExecuTrainSim'
        slot-name: 'production'
        package: . # Deploy from the workspace root