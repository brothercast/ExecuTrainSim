# azure-deploy.yml - Optimized Workflow (Previous Commit Packaging) for Azure
name: ğŸš€ Deploy Full Node.js App to Azure Web App

on:
  push:
    branches:
      - main # or your production branch

  workflow_dispatch: # Enable manual triggering from GitHub Actions UI

env:
  AZURE_WEBAPP_NAME: 'ExecuTrainSim' # âš™ï¸ Replace with your Azure Web App name
  AZURE_RESOURCE_GROUP: 'ExecuTrainSimGroup' # âš™ï¸ Replace with your Azure Resource Group name
  NODE_VERSION: '20.x' # âš™ï¸ Set your desired Node.js version here

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production # Marks this as a production deployment

    steps:
      - name: â˜ï¸ Checkout code # â¬‡ï¸ Get code from GitHub repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Node.js environment # âš™ï¸ Define Node.js environment for build and deploy
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }} # Use version defined in workflow environment variables

      - name: ğŸ—ï¸ Install and Build Application # ğŸ“¦ Install dependencies and build both client and server
        run: |
          echo "âš™ï¸ Starting full application install and build process..."
          echo "  â¡ï¸ Building executrainsim (React Client)..."
          cd executrainsim
          npm ci # âš¡ï¸ Use npm ci for clean and faster installs in CI
          npm run build # ğŸ”¨ Build React application
          echo "  âœ… executrainsim build completed successfully."
          cd ..
          echo "  â¡ï¸ Installing executrainserver (Node.js Server) dependencies..."
          cd executrainserver
          npm ci # âš¡ï¸ Use npm ci for clean and faster server dependency install
          echo "  âœ… executrainserver dependencies installed successfully."
          echo "âœ… Full application install and build process completed."
          cd .. # Return to workspace root

      - name: ğŸ“¦ Prepare Deployment Package # ğŸ“‚ Create deployment package with necessary files in simpler 'deploy' structure (Previous Commit)
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          rm -rf deploy # ğŸ§¹ Clean up any previous package - now using 'deploy' directory
          mkdir deploy # ğŸ“‚ Create a fresh 'deploy' directory - simpler structure

          echo "  â¡ï¸ Copying executrainserver files to deploy root..." # Adjusted log message
          cp -r executrainserver/* deploy/ # ğŸ“‚ Copy server files directly to 'deploy' root

          echo "  â¡ï¸ Copying executrainsim build output to deploy/executrainsim-build..." # Adjusted log message
          mkdir deploy/executrainsim-build # ğŸ“‚ Create client build subdirectory in 'deploy'
          cp -r executrainsim/build/* deploy/executrainsim-build/ # ğŸ“‚ Copy client build to subdirectory in 'deploy'

          echo "  â¡ï¸ Copying startup.sh to deploy root..."
          cp startup.sh deploy/ # ğŸ“‚ Copy startup script to 'deploy' root

          echo "âœ… Deployment package created successfully at 'deploy'." # Adjusted log message
          echo "  ğŸ” Listing contents of deploy root:" # Adjusted log message
          ls -l deploy
          echo "  ğŸ” Listing contents of deploy/executrainserver:" # Adjusted log message
          ls -l deploy/executrainserver
          echo "  ğŸ” Listing contents of deploy/executrainsim-build:" # Adjusted log message
          ls -l deploy/executrainsim-build

      - name: ğŸ”’ Login to Azure # ğŸ”‘ Authenticate with Azure using Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # ğŸ”‘ Use AZURE_CREDENTIALS secret

      - name: ğŸš€ Deploy to Azure Web App # â˜ï¸ Deploy 'deploy' package to Azure Web App - Adjusted package path
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }} # âš™ï¸ Use Web App name from environment variable
          slot-name: 'production' # ğŸ¯ Deploy to production slot
          package: deploy # ğŸ“¦ Deploy the 'deploy' directory - Adjusted package path

      - name: âš™ï¸ Set WEBSITE_NODE_DEFAULT_VERSION App Setting via Azure CLI # ğŸ› ï¸ Ensure correct Node.js version on Azure
        run: |
          echo "âš™ï¸ Setting WEBSITE_NODE_DEFAULT_VERSION App Setting via Azure CLI..."
          az webapp config appsettings set --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --settings WEBSITE_NODE_DEFAULT_VERSION="${{ env.NODE_VERSION }}"
          echo "âœ… WEBSITE_NODE_DEFAULT_VERSION App Setting set to ${{ env.NODE_VERSION }} via Azure CLI."